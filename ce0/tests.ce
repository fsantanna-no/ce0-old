native pre _{
    #include <string.h>
}

native _{
    FILE* stropen (const char* mode, size_t size, char* str) {
        size = (size != 0) ? size : strlen(str);
        return fmemopen(str, size, mode);
    }
}

type Bool {
    False: ()
    True:  ()
}

func asbool: Int -> Bool {
    return _(arg ? (Bool){True} : (Bool){False})
}

var inp: _(FILE*) = ?

func lx_blanks: () -> () {
    loop {
        var c: Int = _fgetc _inp
        if asbool _(c == '-') {
            set c = _fgetc _inp
            if asbool _(c == '-') {
                loop {
                    set c = _fgetc _inp
                    if asbool _(c == EOF) {
                        break
                    }
                    if asbool _(c == '\n') {
                        native _(ungetc(c, inp);)
                        break
                    }
                }
            } else {
                native _(ungetc(c, inp);)
                native _(ungetc('-', inp);)
                return ()
            }
        } else {
            if asbool _(c=='\n' || c==' ') {
            } else {
                native _(ungetc(c, inp);)
                return ()
            }
        }
    }
}

func t_lexer: () -> () {
    set inp = _{stropen("r", 0, "--foobar")}
    {
        var c: Int = call _fgetc inp
        native _(assert(c == '-');)
        native _(ungetc(c,inp);)
    }
    {
        call lx_blanks ()
        var c: Int = call _fgetc inp
        native _(assert(c == EOF);)
    }
    call _fclose inp
}

call t_lexer ()
